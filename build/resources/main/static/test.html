<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat POC - WebSocket í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        h2 { margin-top: 0; color: #333; }
        input, button { padding: 10px; margin: 5px 0; }
        input { width: 300px; }
        button { cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }
        #messages { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
        .message { padding: 8px; margin: 5px 0; border-radius: 4px; }
        .message.user { background: #d4edda; text-align: right; }
        .message.admin { background: #cce5ff; text-align: left; }
        .status { padding: 5px 10px; border-radius: 4px; display: inline-block; }
        .status.connected { background: #28a745; color: white; }
        .status.disconnected { background: #dc3545; color: white; }
        #log { font-family: monospace; font-size: 12px; background: #1e1e1e; color: #0f0; padding: 10px; height: 150px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ—¨ï¸ Chat POC - WebSocket í…ŒìŠ¤íŠ¸</h1>
    
    <div class="section">
        <h2>1. ë¡œê·¸ì¸</h2>
        <input type="email" id="email" placeholder="ì´ë©”ì¼ (ì˜ˆ: user1@email.com)" value="user1@email.com">
        <select id="userType">
            <option value="user">User</option>
            <option value="admin">Admin</option>
        </select>
        <button onclick="login()">ë¡œê·¸ì¸</button>
        <span id="loginStatus" class="status disconnected">ë¡œê·¸ì¸ í•„ìš”</span>
    </div>
    
    <div class="section">
        <h2>2. WebSocket ì—°ê²°</h2>
        <button onclick="connect()" id="connectBtn" disabled>ì—°ê²°</button>
        <button onclick="disconnect()" id="disconnectBtn" disabled>ì—°ê²° í•´ì œ</button>
        <span id="wsStatus" class="status disconnected">ì—°ê²° ì•ˆë¨</span>
    </div>
    
    <div class="section">
        <h2>3. ì±„íŒ…</h2>
        <div>ì±„íŒ…ë°© ID: <input type="number" id="roomId" value="1" style="width: 60px;"></div>
        <button onclick="subscribeChatRoom()" id="subscribeBtn" disabled>ì±„íŒ…ë°© êµ¬ë…</button>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." disabled>
        <button onclick="sendMessage()" id="sendBtn" disabled>ì „ì†¡</button>
    </div>
    
    <div class="section">
        <h2>ë¡œê·¸</h2>
        <div id="log"></div>
    </div>

    <script>
        let stompClient = null;
        let currentSubscription = null;
        
        function log(msg) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }
        
        async function login() {
            const email = document.getElementById('email').value;
            const userType = document.getElementById('userType').value;
            const endpoint = userType === 'admin' ? '/api/admins/login' : '/api/users/login';
            
            try {
                const response = await fetch(`http://localhost:8080${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email })
                });
                const data = await response.json();
                
                if (data.success) {
                    log(`âœ… ë¡œê·¸ì¸ ì„±ê³µ: ${data.data.email} (${data.data.userType})`);
                    document.getElementById('loginStatus').textContent = `${data.data.email}`;
                    document.getElementById('loginStatus').className = 'status connected';
                    document.getElementById('connectBtn').disabled = false;
                } else {
                    log(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${data.message}`);
                }
            } catch (e) {
                log(`âŒ ë¡œê·¸ì¸ ì—ëŸ¬: ${e.message}`);
            }
        }
        
        function connect() {
            const socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, 
                (frame) => {
                    log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
                    document.getElementById('wsStatus').textContent = 'ì—°ê²°ë¨';
                    document.getElementById('wsStatus').className = 'status connected';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('subscribeBtn').disabled = false;
                    
                    // Admin ì•Œë¦¼ êµ¬ë…
                    if (document.getElementById('userType').value === 'admin') {
                        stompClient.subscribe('/topic/admin/chatrooms', (message) => {
                            const notification = JSON.parse(message.body);
                            log(`ğŸ”” Admin ì•Œë¦¼: ì±„íŒ…ë°© ${notification.chatRoomId} - ì½ì§€ì•Šì€ ë©”ì‹œì§€: ${notification.unreadCount}`);
                        });
                        log('ğŸ“¡ Admin ì•Œë¦¼ ì±„ë„ êµ¬ë…');
                    }
                },
                (error) => {
                    log(`âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: ${error}`);
                }
            );
        }
        
        function disconnect() {
            if (stompClient) {
                stompClient.disconnect();
                log('ğŸ”Œ WebSocket ì—°ê²° í•´ì œ');
                document.getElementById('wsStatus').textContent = 'ì—°ê²° ì•ˆë¨';
                document.getElementById('wsStatus').className = 'status disconnected';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('subscribeBtn').disabled = true;
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            }
        }
        
        function subscribeChatRoom() {
            const roomId = document.getElementById('roomId').value;
            
            if (currentSubscription) {
                currentSubscription.unsubscribe();
            }
            
            currentSubscription = stompClient.subscribe(`/topic/chat/${roomId}`, (message) => {
                const msg = JSON.parse(message.body);
                displayMessage(msg);
                log(`ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ : [${msg.senderType}] ${msg.content}`);
            });
            
            log(`ğŸ“¡ ì±„íŒ…ë°© ${roomId} êµ¬ë… ì‹œì‘`);
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
        }
        
        function sendMessage() {
            const roomId = document.getElementById('roomId').value;
            const content = document.getElementById('messageInput').value;
            
            if (!content.trim()) return;
            
            stompClient.send(`/app/chat/${roomId}/send`, {}, JSON.stringify({ content }));
            log(`ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡: ${content}`);
            document.getElementById('messageInput').value = '';
        }
        
        function displayMessage(msg) {
            const messagesEl = document.getElementById('messages');
            const isUser = msg.senderType === 'USER';
            messagesEl.innerHTML += `
                <div class="message ${isUser ? 'user' : 'admin'}">
                    <strong>${msg.senderType}</strong>: ${msg.content}
                    <br><small>${msg.createdAt}</small>
                </div>
            `;
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
