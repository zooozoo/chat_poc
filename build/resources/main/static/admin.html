<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat POC - ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .admin-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
            margin: 20px auto;
            max-width: 1400px;
        }

        .sidebar {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-chat {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 16px;
            flex-direction: column;
            gap: 16px;
        }

        .chat-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
    </style>
</head>

<body>
    <div class="admin-layout">
        <!-- ì‚¬ì´ë“œë°”: ì±„íŒ…ë°© ëª©ë¡ -->
        <div class="sidebar">
            <div class="chat-header">
                <h2>ì±„íŒ… ëª©ë¡</h2>
                <button onclick="logout()" class="btn btn-secondary"
                    style="font-size: 11px; padding: 4px 8px; background: rgba(255,255,255,0.2); border: none; color: white;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div id="chatList" class="chat-list-container">
                <!-- ì±„íŒ…ë°© ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </div>
        </div>

        <!-- ë©”ì¸: ì±„íŒ… í™”ë©´ -->
        <div class="main-chat">
            <div id="chatHeader" class="chat-header"
                style="display: none; background: white; color: var(--text-primary); border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="chatroom-avatar" style="width: 32px; height: 32px; font-size: 14px; margin: 0;">U</div>
                    <h3 id="currentUserName">ì‚¬ìš©ì</h3>
                </div>
            </div>

            <div id="chatPlaceholder" class="chat-placeholder">
                <span style="font-size: 48px;">ğŸ’¬</span>
                <p>ì™¼ìª½ ëª©ë¡ì—ì„œ ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</p>
            </div>

            <div id="chatArea" style="display: none; flex: 1; flex-direction: column; height: 100%;">
                <div class="messages-container" id="messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="messageInput" class="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                    <button onclick="sendMessage()" class="send-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentRoomId = null;
        let currentSubscription = null;
        let readSubscription = null;

        async function init() {
            try {
                // 1. ë‚´ ì •ë³´ ì¡°íšŒ (ë¡œê·¸ì¸ ì²´í¬)
                const adminRes = await fetch('/api/admins/me');
                if (adminRes.status === 401) {
                    window.location.href = '/index.html';
                    return;
                }

                // 2. WebSocket ì—°ê²°
                connectWebSocket();

                // 3. ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
                loadChatRooms();

            } catch (e) {
                console.error('Init failed', e);
            }
        }

        async function loadChatRooms() {
            const res = await fetch('/api/admins/chatrooms');
            const data = await res.json();

            if (data.success) {
                renderChatList(data.data.chatRooms);
            }
        }

        function renderChatList(rooms) {
            const container = document.getElementById('chatList');
            container.innerHTML = '';

            rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = `chatroom-item ${currentRoomId === room.id ? 'active' : ''}`;
                div.onclick = () => selectRoom(room.id, room.userEmail);
                div.id = `room-${room.id}`;

                div.innerHTML = `
                    <div class="chatroom-avatar">${room.userEmail[0].toUpperCase()}</div>
                    <div class="chatroom-info">
                        <div class="chatroom-name">${room.userEmail}</div>
                        <div class="chatroom-preview" id="preview-${room.id}">${room.lastMessageContent || 'ëŒ€í™” ì—†ìŒ'}</div>
                    </div>
                    <div class="chatroom-meta">
                        <div class="chatroom-time">${formatTime(room.lastMessageAt)}</div>
                        ${room.unreadCount > 0 ? `<div class="unread-badge" id="badge-${room.id}">${room.unreadCount}</div>` : `<div class="unread-badge hidden" id="badge-${room.id}">0</div>`}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            stompClient.connect({}, () => {
                console.log('Connected');

                // ì±„íŒ…ë°© ëª©ë¡ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ êµ¬ë… (Admin ì „ìš© ì±„ë„)
                stompClient.subscribe('/topic/admin/chatrooms', (message) => {
                    const noti = JSON.parse(message.body);
                    updateChatRoomPreview(noti);
                });

            });
        }

        function updateChatRoomPreview(noti) {
            // ëª©ë¡ì— ì—†ëŠ” ë°©ì´ë©´ ìƒˆë¡œê³ ì¹¨ (ê°„ë‹¨í•˜ê²Œ ì²˜ë¦¬)
            const roomEl = document.getElementById(`room-${noti.chatRoomId}`);
            if (!roomEl) {
                loadChatRooms();
                return;
            }

            // í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
            document.getElementById(`preview-${noti.chatRoomId}`).textContent = noti.lastMessageContent;

            // í˜„ì¬ ë³´ê³ ìˆëŠ” ë°©ì´ ì•„ë‹ˆë©´ ë±ƒì§€ ì—…ë°ì´íŠ¸
            if (currentRoomId !== noti.chatRoomId) {
                const badge = document.getElementById(`badge-${noti.chatRoomId}`);
                badge.textContent = noti.unreadCount;
                badge.classList.remove('hidden');

                // ëª©ë¡ ë§¨ ìœ„ë¡œ ì˜¬ë¦¬ê¸° (DOM ì´ë™)
                const container = document.getElementById('chatList');
                container.insertBefore(roomEl, container.firstChild);
            }
        }

        async function selectRoom(roomId, userEmail) {
            currentRoomId = roomId;
            document.getElementById('currentUserName').textContent = userEmail;

            // UI ì „í™˜
            document.getElementById('chatPlaceholder').style.display = 'none';
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('chatArea').style.display = 'flex';

            // ë±ƒì§€ ì œê±°
            const badge = document.getElementById(`badge-${roomId}`);
            if (badge) badge.classList.add('hidden');

            // ì´ì „ êµ¬ë… í•´ì œ
            if (currentSubscription) currentSubscription.unsubscribe();
            if (readSubscription) readSubscription.unsubscribe();

            // APIë¡œ ë©”ì‹œì§€ ë¡œë“œ (ì…ì¥ ì²˜ë¦¬ -> ì½ìŒ ì²˜ë¦¬ ë¨)
            const res = await fetch(`/api/chatrooms/${roomId}`);
            const data = await res.json();

            if (data.success) {
                renderMessages(data.data.messages);
                scrollToBottom();

                // ìƒˆ ë°© êµ¬ë…
                currentSubscription = stompClient.subscribe(`/topic/chat/${roomId}`, (message) => {
                    const msg = JSON.parse(message.body);
                    displayMessage(msg);
                    scrollToBottom();
                });

                // ì½ìŒ ì•Œë¦¼ êµ¬ë…
                readSubscription = stompClient.subscribe(`/topic/chat/${roomId}/read`, (message) => {
                    markAllAsRead();
                });
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            messages.forEach(displayMessage);
        }

        function displayMessage(msg) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');

            // ADMINì´ ë³´ë‚¸ ë©”ì‹œì§€ = ë‚˜(Admin)ì—ê²ŒëŠ” 'user' í´ë˜ìŠ¤ (ì˜¤ë¥¸ìª½ - ìƒ‰ìƒì€ CSSë¡œ ì¡°ì •)
            // USERê°€ ë³´ë‚¸ ë©”ì‹œì§€ = ë‚˜(Admin)ì—ê²ŒëŠ” 'admin' í´ë˜ìŠ¤ (ì™¼ìª½)
            // ì£¼ì˜: style.cssì—ì„œ .message.userë¥¼ ì˜¤ë¥¸ìª½(ë‚´êº¼), .message.adminì„ ì™¼ìª½(ìƒëŒ€)ìœ¼ë¡œ ì •ì˜í–ˆìŒ.
            // ì—¬ê¸°ì„œëŠ” `isMe`ê°€ ì°¸ì´ë©´ `.message.user` í´ë˜ìŠ¤ë¥¼ ì¤˜ì„œ ì˜¤ë¥¸ìª½ì— ë°°ì¹˜í•´ì•¼ í•¨.

            const isMe = msg.senderType === 'ADMIN';

            div.className = `message ${isMe ? 'user' : 'admin'}`;

            div.innerHTML = `
                <div class="message-bubble">
                    ${msg.content}
                </div>
                <div class="message-meta">
                    ${isMe ? `<span class="read-indicator ${msg.read ? 'read' : ''}" data-msg-id="${msg.id}">${msg.read ? 'ì½ìŒ' : 'ì•ˆì½ìŒ'}</span>` : ''}
                    <span>${formatTime(msg.createdAt)}</span>
                </div>
            `;

            container.appendChild(div);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (content && stompClient && currentRoomId) {
                stompClient.send(`/app/chat/${currentRoomId}/send`, {}, JSON.stringify({
                    content: content
                }));
                input.value = '';
                input.focus();
            }
        }

        function markAllAsRead() {
            document.querySelectorAll('.read-indicator').forEach(el => {
                el.textContent = 'ì½ìŒ';
                el.classList.add('read');
            });
        }

        function scrollToBottom() {
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr.replace(' ', 'T'));
            return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        function logout() {
            fetch('/api/admins/logout', { method: 'POST' })
                .then(() => window.location.href = '/index.html');
        }

        // Enter í‚¤
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        init();
    </script>
</body>

</html>