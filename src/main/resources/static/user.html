<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat POC - ì‚¬ìš©ì ì±„íŒ…</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>

<body>
    <div class="container">
        <header class="card-header"
            style="border-radius: 16px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="font-size: 20px;">ğŸ’¬ ìƒë‹´ ì±„íŒ…</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span id="userEmail" style="font-size: 14px;"></span>
                <button onclick="logout()" class="btn btn-secondary"
                    style="padding: 6px 12px; font-size: 12px;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <div class="card chat-container">
            <div class="messages-container" id="messages">
                <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>

            <div class="chat-input-container">
                <input type="text" id="messageInput" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." disabled>
                <button id="sendBtn" onclick="sendMessage()" class="send-btn" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let chatRoomId = null;
        let myEmail = null;

        // JWT í† í° í—¬í¼ í•¨ìˆ˜
        function getAccessToken() {
            return localStorage.getItem('accessToken');
        }

        function getAuthHeaders() {
            const token = getAccessToken();
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        }

        async function fetchWithAuth(url, options = {}) {
            options.headers = { ...options.headers, ...getAuthHeaders() };
            const response = await fetch(url, options);
            if (response.status === 401 || response.status === 403) {
                // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                logout();
                return null;
            }
            return response;
        }

        async function init() {
            // í† í° í™•ì¸
            if (!getAccessToken()) {
                window.location.href = '/index.html';
                return;
            }

            try {
                // 1. ë‚´ ì •ë³´ ì¡°íšŒ
                const userRes = await fetchWithAuth('/api/users/me');
                if (!userRes) return;

                const userData = await userRes.json();

                if (!userData.success) {
                    window.location.href = '/index.html';
                    return;
                }
                myEmail = userData.data.email;
                document.getElementById('userEmail').textContent = myEmail;

                // 2. ì±„íŒ…ë°© ì¡°íšŒ (ì—†ìœ¼ë©´ ìë™ìƒì„±)
                const roomRes = await fetchWithAuth('/api/users/chatroom');
                if (!roomRes) return;

                const roomData = await roomRes.json();

                if (roomData.success) {
                    chatRoomId = roomData.data.id;

                    // 3. ì±„íŒ…ë°© ì…ì¥ (ë©”ì‹œì§€ ëª©ë¡ ë¡œë“œ + ì½ìŒ ì²˜ë¦¬)
                    await enterChatRoom();

                    // 4. WebSocket ì—°ê²°
                    connectWebSocket();
                }
            } catch (e) {
                console.error('Initialization failed', e);
            }
        }

        async function enterChatRoom() {
            const res = await fetchWithAuth(`/api/chatrooms/${chatRoomId}`);
            if (!res) return;

            const data = await res.json();

            if (data.success) {
                const container = document.getElementById('messages');
                container.innerHTML = '';

                // ì´ì „ ë©”ì‹œì§€ ë Œë”ë§
                data.data.messages.forEach(msg => {
                    displayMessage(msg);
                });

                scrollToBottom();
            }
        }

        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null; // ë””ë²„ê·¸ ë¡œê·¸ ë„ê¸°

            // STOMP CONNECT ì‹œ Authorization í—¤ë” ì „ë‹¬
            const connectHeaders = {
                'Authorization': 'Bearer ' + getAccessToken()
            };

            stompClient.connect(connectHeaders, (frame) => {
                console.log('Connected: ' + frame);

                // 1. ì±„íŒ… ë©”ì‹œì§€ êµ¬ë…
                stompClient.subscribe(`/topic/chat/${chatRoomId}`, (message) => {
                    const msg = JSON.parse(message.body);
                    displayMessage(msg);
                    scrollToBottom();

                    // ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì½ìŒ ì²˜ë¦¬
                    stompClient.send(`/app/chat/${chatRoomId}/read`, {}, {});
                });

                // ì…ì¥(ì—°ê²°) ì‹œ ì½ìŒ ì²˜ë¦¬ ì „ì†¡
                stompClient.send(`/app/chat/${chatRoomId}/read`, {}, {});

                // 2. ì½ìŒ ì•Œë¦¼ êµ¬ë…
                stompClient.subscribe(`/topic/chat/${chatRoomId}/read`, (message) => {
                    markAllAsRead();
                });

                // ì…ë ¥ í™œì„±í™”
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;

            }, (error) => {
                console.error('WebSocket connection failed:', error);
                alert('ì±„íŒ… ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
                logout();
            });
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (content && stompClient) {
                stompClient.send(`/app/chat/${chatRoomId}/send`, {}, JSON.stringify({
                    content: content
                }));
                input.value = '';
                input.focus();
            }
        }

        function displayMessage(msg) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');

            // USERê°€ ë³´ë‚¸ ë©”ì‹œì§€ = ë‚˜(User)ì—ê²ŒëŠ” 'user' í´ë˜ìŠ¤ (ì˜¤ë¥¸ìª½)
            // ADMINì´ ë³´ë‚¸ ë©”ì‹œì§€ = ë‚˜(User)ì—ê²ŒëŠ” 'admin' í´ë˜ìŠ¤ (ì™¼ìª½)
            const isMe = msg.senderType === 'USER';

            div.className = `message ${isMe ? 'user' : 'admin'}`;

            div.innerHTML = `
                <div class="message-bubble">
                    ${msg.content}
                </div>
                <div class="message-meta">
                    ${isMe ? `<span class="read-indicator ${msg.isRead ? 'read' : ''}" data-msg-id="${msg.id}">${msg.isRead ? 'ì½ìŒ' : 'ì•ˆì½ìŒ'}</span>` : ''}
                    <span>${formatTime(msg.createdAt)}</span>
                </div>
            `;

            container.appendChild(div);
        }

        function markAllAsRead() {
            document.querySelectorAll('.read-indicator').forEach(el => {
                el.textContent = 'ì½ìŒ';
                el.classList.add('read');
            });
        }

        function scrollToBottom() {
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }

        function formatTime(dateStr) {
            // "2026-01-09 16:30:26" -> "ì˜¤í›„ 4:30"
            if (!dateStr) return '';
            const date = new Date(dateStr.replace(' ', 'T'));
            return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        function logout() {
            localStorage.removeItem('accessToken');
            window.location.href = '/index.html';
        }

        // Enter í‚¤ ì²˜ë¦¬
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        init();
    </script>
</body>

</html>