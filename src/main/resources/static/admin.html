<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat POC - ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .admin-layout {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
            margin: 20px auto;
            max-width: 1400px;
        }

        .sidebar {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-chat {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 16px;
            flex-direction: column;
            gap: 16px;
        }

        .chat-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .sidebar-tabs {
            display: flex;
            background: #f1f5f9;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            font-size: 14px;
        }

        .sidebar-tab.active {
            background: white;
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .assign-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: auto;
        }

        .assign-btn:hover {
            background: var(--primary-dark);
        }

        .assigned-admin {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 4px;
            white-space: nowrap;
        }

        .chatroom-name {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
        }
    </style>
</head>

<body>
    <div class="admin-layout">
        <!-- ì‚¬ì´ë“œë°”: ì±„íŒ…ë°© ëª©ë¡ -->
        <div class="sidebar">
            <div class="chat-header">
                <h2>ê´€ë¦¬ì ì±„íŒ…</h2>
                <button onclick="logout()" class="btn btn-secondary"
                    style="font-size: 11px; padding: 4px 8px; background: rgba(255,255,255,0.2); border: none; color: white;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="sidebar-tabs">
                <div class="sidebar-tab active" onclick="switchTab('all')" id="tab-all">ì „ì²´ (0)</div>
                <div class="sidebar-tab" onclick="switchTab('mine')" id="tab-mine">ë‚´ ìƒë‹´ (0)</div>
                <div class="sidebar-tab" onclick="switchTab('unassigned')" id="tab-unassigned">ë¯¸ë°°ì • (0)</div>
            </div>

            <div id="chatList" class="chat-list-container">
                <!-- ì±„íŒ…ë°© ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </div>
        </div>

        <!-- ë©”ì¸: ì±„íŒ… í™”ë©´ -->
        <div class="main-chat">
            <div id="chatHeader" class="chat-header"
                style="display: none; background: white; color: var(--text-primary); border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="chatroom-avatar" style="width: 32px; height: 32px; font-size: 14px; margin: 0;">U</div>
                    <h3 id="currentUserName">ì‚¬ìš©ì</h3>
                </div>
                <button id="assignBtn" class="assign-btn" style="display: none;" onclick="assignCurrentRoom()">ìƒë‹´
                    ì‹œì‘í•˜ê¸°</button>
            </div>

            <div id="chatPlaceholder" class="chat-placeholder">
                <span style="font-size: 48px;">ğŸ’¬</span>
                <p>ì™¼ìª½ ëª©ë¡ì—ì„œ ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</p>
            </div>

            <div id="chatArea" style="display: none; flex: 1; min-height: 0; flex-direction: column;">
                <div class="messages-container" id="messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="messageInput" class="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                    <button onclick="sendMessage()" class="send-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentRoomId = null;
        let currentSubscription = null;
        let readSubscription = null;
        let currentAdminId = null;
        let activeTab = 'all'; // 'all', 'unassigned', or 'mine'

        // JWT í† í° í—¬í¼ í•¨ìˆ˜
        function getAccessToken() {
            return localStorage.getItem('accessToken');
        }

        function getAuthHeaders() {
            const token = getAccessToken();
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        }

        async function fetchWithAuth(url, options = {}) {
            options.headers = { ...options.headers, ...getAuthHeaders() };
            const response = await fetch(url, options);
            if (response.status === 401 || response.status === 403) {
                logout();
                return null;
            }
            return response;
        }

        async function init() {
            // í† í° í™•ì¸
            if (!getAccessToken()) {
                window.location.href = '/index.html';
                return;
            }

            try {
                // 1. ë‚´ ì •ë³´ ì¡°íšŒ (ë¡œê·¸ì¸ ì²´í¬)
                const adminRes = await fetchWithAuth('/api/admins/me');
                if (!adminRes) return;

                const adminData = await adminRes.json();
                if (adminData.success) {
                    currentAdminId = adminData.data.id;
                } else {
                    window.location.href = '/index.html';
                    return;
                }

                // 2. WebSocket ì—°ê²°
                connectWebSocket();

                // 3. ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
                loadChatRooms();

                // 4. ì „ì²´ íƒ­ ì¹´ìš´íŠ¸ ì´ˆê¸°í™” (ë¹„í™œì„± íƒ­ í¬í•¨)
                updateInitialTabCounts();

            } catch (e) {
                console.error('Init failed', e);
            }
        }

        async function updateInitialTabCounts() {
            try {
                // ë¯¸ë°°ì • ì¹´ìš´íŠ¸
                const resUnassigned = await fetchWithAuth('/api/admins/chatrooms/unassigned');
                if (resUnassigned) {
                    const dataUnassigned = await resUnassigned.json();
                    if (dataUnassigned.success) {
                        updateTabCount('unassigned', dataUnassigned.data.chatRooms.length);
                    }
                }

                // ë‚´ ìƒë‹´ ì¹´ìš´íŠ¸
                const resMine = await fetchWithAuth('/api/admins/chatrooms/mine');
                if (resMine) {
                    const dataMine = await resMine.json();
                    if (dataMine.success) {
                        updateTabCount('mine', dataMine.data.chatRooms.length);
                    }
                }

                // ì „ì²´ ì¹´ìš´íŠ¸
                const resAll = await fetchWithAuth('/api/admins/chatrooms');
                if (resAll) {
                    const dataAll = await resAll.json();
                    if (dataAll.success) {
                        updateTabCount('all', dataAll.data.chatRooms.length);
                    }
                }
            } catch (e) {
                console.error('Failed to update tab counts', e);
            }
        }

        async function switchTab(tab) {
            if (activeTab === tab) return;
            activeTab = tab;

            document.querySelectorAll('.sidebar-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            // íƒ­ ì „í™˜ ì‹œ ì±„íŒ…ë°© ì„ íƒ í•´ì œ (ì‹¬í”Œí•˜ê²Œ)
            currentRoomId = null;
            document.getElementById('chatHeader').style.display = 'none';
            document.getElementById('chatArea').style.display = 'none';
            document.getElementById('chatPlaceholder').style.display = 'flex';
            if (currentSubscription) currentSubscription.unsubscribe();

            loadChatRooms();
        }

        async function loadChatRooms() {
            let endpoint;
            if (activeTab === 'unassigned') endpoint = '/api/admins/chatrooms/unassigned';
            else if (activeTab === 'mine') endpoint = '/api/admins/chatrooms/mine';
            else endpoint = '/api/admins/chatrooms';

            const res = await fetchWithAuth(endpoint);
            if (!res) return;

            const data = await res.json();

            if (data.success) {
                renderChatList(data.data.chatRooms);
                updateTabCount(activeTab, data.data.chatRooms.length);
            }
        }

        function updateTabCount(tab, count) {
            const el = document.getElementById(`tab-${tab}`);
            let text = '';
            if (tab === 'unassigned') text = 'ë¯¸ë°°ì •';
            else if (tab === 'mine') text = 'ë‚´ ìƒë‹´';
            else text = 'ì „ì²´';

            el.textContent = `${text} (${count})`;
        }

        function renderChatList(rooms) {
            const container = document.getElementById('chatList');
            container.innerHTML = '';

            if (rooms.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding: 20px; color: #888;">ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = `chatroom-item ${currentRoomId === room.id ? 'active' : ''}`;
                div.onclick = () => selectRoom(room.id, room.userEmail, room.assignedAdminEmail);
                div.id = `room-${room.id}`;

                div.innerHTML = `
                    <div class="chatroom-avatar">${room.userEmail[0].toUpperCase()}</div>
                    <div class="chatroom-info">
                        <div class="chatroom-name">
                            ${room.userEmail}
                            ${room.assignedAdminEmail ? `<span class="assigned-admin">ë‹´ë‹¹ì: ${room.assignedAdminEmail}</span>` : ''}
                        </div>
                        <div class="chatroom-preview" id="preview-${room.id}">${room.lastMessageContent || 'ëŒ€í™” ì—†ìŒ'}</div>
                    </div>
                    <div class="chatroom-meta">
                        <div class="chatroom-time">${formatTime(room.lastMessageAt)}</div>
                        ${room.unreadCount > 0 ? `<div class="unread-badge" id="badge-${room.id}">${room.unreadCount}</div>` : `<div class="unread-badge hidden" id="badge-${room.id}">0</div>`}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            // STOMP CONNECT ì‹œ Authorization í—¤ë” ì „ë‹¬
            const connectHeaders = {
                'Authorization': 'Bearer ' + getAccessToken()
            };

            stompClient.connect(connectHeaders, () => {
                console.log('Connected');

                // ì±„íŒ…ë°© ëª©ë¡ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ êµ¬ë… (Admin ì „ìš© ì±„ë„ - ê¸°ì¡´)
                stompClient.subscribe('/topic/admin/chatrooms', (message) => {
                    const noti = JSON.parse(message.body);
                    updateChatRoomPreview(noti);
                });

                // ë°°ì • ì•Œë¦¼ êµ¬ë…
                stompClient.subscribe('/topic/admin/assignments', (message) => {
                    const noti = JSON.parse(message.body);
                    handleAssignmentNotification(noti);
                });

                // ì½ìŒ ì•Œë¦¼(ëª©ë¡ ê°±ì‹ ìš©) êµ¬ë…
                stompClient.subscribe('/topic/admin/reads', (message) => {
                    const noti = JSON.parse(message.body);
                    handleReadNotificationForList(noti);
                });

            });
        }

        function handleReadNotificationForList(noti) {
            if (noti.readByType === 'ADMIN') {
                const badge = document.getElementById(`badge-${noti.chatRoomId}`);
                if (badge) {
                    badge.textContent = '0';
                    badge.classList.add('hidden');
                }
            }
        }

        function handleAssignmentNotification(noti) {
            if (noti.assignedAdminId === currentAdminId) {
                if (activeTab === 'mine') {
                    loadChatRooms();
                } else {
                    const el = document.getElementById(`room-${noti.chatRoomId}`);
                    if (el) {
                        el.remove();
                        updateTabCount(activeTab, document.querySelectorAll('.chatroom-item').length);
                    }
                }
            } else {
                if (activeTab === 'unassigned') {
                    const el = document.getElementById(`room-${noti.chatRoomId}`);
                    if (el) {
                        el.remove();
                        updateTabCount(activeTab, document.querySelectorAll('.chatroom-item').length);
                    } else {
                        loadChatRooms();
                    }
                }
            }

            if (activeTab === 'all') {
                loadChatRooms();
            }
        }

        function updateChatRoomPreview(noti) {
            const roomEl = document.getElementById(`room-${noti.chatRoomId}`);

            const belongsToUnassigned = !noti.assignedAdminId;
            const belongsToMe = noti.assignedAdminId === currentAdminId;

            if (activeTab === 'unassigned') {
                if (belongsToUnassigned) {
                    if (!roomEl) {
                        loadChatRooms();
                        return;
                    }
                } else {
                    if (roomEl) {
                        roomEl.remove();
                        updateTabCount(activeTab, document.querySelectorAll('.chatroom-item').length);
                    }
                    return;
                }
            } else if (activeTab === 'mine') {
                if (belongsToMe) {
                    if (!roomEl) {
                        loadChatRooms();
                        return;
                    }
                } else {
                    if (roomEl) {
                        roomEl.remove();
                        updateTabCount(activeTab, document.querySelectorAll('.chatroom-item').length);
                    }
                    return;
                }
            } else if (activeTab === 'all') {
                if (!roomEl) {
                    loadChatRooms();
                    return;
                }
            }

            if (!roomEl) return;

            document.getElementById(`preview-${noti.chatRoomId}`).textContent = noti.lastMessageContent;

            if (currentRoomId !== noti.chatRoomId) {
                const badge = document.getElementById(`badge-${noti.chatRoomId}`);
                if (badge) {
                    badge.textContent = noti.unreadCount;
                    badge.classList.remove('hidden');
                }

                const container = document.getElementById('chatList');
                if (container.firstChild !== roomEl) {
                    container.insertBefore(roomEl, container.firstChild);
                }
            }
        }

        async function selectRoom(roomId, userEmail, assignedAdminEmail) {
            currentRoomId = roomId;
            document.getElementById('currentUserName').textContent = userEmail;

            document.getElementById('chatPlaceholder').style.display = 'none';
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('chatArea').style.display = 'flex';

            const assignBtn = document.getElementById('assignBtn');
            if (activeTab === 'unassigned' && !assignedAdminEmail) {
                assignBtn.style.display = 'block';
                document.getElementById('messageInput').disabled = true;
                document.getElementById('messageInput').placeholder = "ìƒë‹´ ì‹œì‘í•˜ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”";
            } else {
                assignBtn.style.display = 'none';
                document.getElementById('messageInput').disabled = false;
                document.getElementById('messageInput').placeholder = "ë©”ì‹œì§€ ì…ë ¥...";
            }

            const badge = document.getElementById(`badge-${roomId}`);
            if (badge) badge.classList.add('hidden');

            if (currentSubscription) currentSubscription.unsubscribe();
            if (readSubscription) readSubscription.unsubscribe();

            const dataRes = await fetchWithAuth(`/api/chatrooms/${roomId}`);
            if (!dataRes) return;

            const data = await dataRes.json();

            if (data.success) {
                renderMessages(data.data.messages);
                scrollToBottom();

                currentSubscription = stompClient.subscribe(`/topic/chat/${roomId}`, (message) => {
                    const msg = JSON.parse(message.body);
                    displayMessage(msg);
                    scrollToBottom();

                    stompClient.send(`/app/chat/${roomId}/read`, {}, {});
                });

                stompClient.send(`/app/chat/${roomId}/read`, {}, {});

                readSubscription = stompClient.subscribe(`/topic/chat/${roomId}/read`, (message) => {
                    markAllAsRead();
                });
            }
        }

        async function assignCurrentRoom() {
            if (!currentRoomId) return;
            if (!confirm("ì´ ìƒë‹´ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const res = await fetchWithAuth(`/api/admins/chatrooms/${currentRoomId}/assign`, { method: 'POST' });
            if (!res) return;

            const data = await res.json();

            if (data.success) {
                alert("ìƒë‹´ì´ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                switchTab('mine');
            } else {
                alert("ë°°ì • ì‹¤íŒ¨: " + (data.error?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            messages.forEach(displayMessage);
        }

        function displayMessage(msg) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');

            const isMe = msg.senderType === 'ADMIN';

            div.className = `message ${isMe ? 'user' : 'admin'}`;

            div.innerHTML = `
                <div class="message-bubble">
                    ${msg.content}
                </div>
                <div class="message-meta">
                    ${isMe ? `<span class="read-indicator ${msg.isRead ? 'read' : ''}" data-msg-id="${msg.id}">${msg.isRead ? 'ì½ìŒ' : 'ì•ˆì½ìŒ'}</span>` : ''}
                    <span>${formatTime(msg.createdAt)}</span>
                </div>
            `;

            container.appendChild(div);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (input.disabled) {
                alert("ë¨¼ì € ìƒë‹´ì„ ì‹œì‘(ë°°ì •)í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (content && stompClient && currentRoomId) {
                stompClient.send(`/app/chat/${currentRoomId}/send`, {}, JSON.stringify({
                    content: content
                }));
                input.value = '';
                input.focus();
            }
        }

        function markAllAsRead() {
            document.querySelectorAll('.read-indicator').forEach(el => {
                el.textContent = 'ì½ìŒ';
                el.classList.add('read');
            });
        }

        function scrollToBottom() {
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr.replace(' ', 'T'));
            return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        function logout() {
            localStorage.removeItem('accessToken');
            window.location.href = '/index.html';
        }

        // Enter í‚¤
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        init();
    </script>
</body>

</html>