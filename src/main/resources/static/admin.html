<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat POC - ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .admin-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
            margin: 20px auto;
            max-width: 1400px;
        }

        .sidebar {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-chat {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 16px;
            flex-direction: column;
            gap: 16px;
        }

        .chat-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .sidebar-tabs {
            display: flex;
            background: #f1f5f9;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            font-size: 14px;
        }

        .sidebar-tab.active {
            background: white;
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .assign-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: auto;
        }

        .assign-btn:hover {
            background: var(--primary-dark);
        }
    </style>
</head>

<body>
    <div class="admin-layout">
        <!-- ì‚¬ì´ë“œë°”: ì±„íŒ…ë°© ëª©ë¡ -->
        <div class="sidebar">
            <div class="chat-header">
                <h2>ê´€ë¦¬ì ì±„íŒ…</h2>
                <button onclick="logout()" class="btn btn-secondary"
                    style="font-size: 11px; padding: 4px 8px; background: rgba(255,255,255,0.2); border: none; color: white;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="sidebar-tabs">
                <div class="sidebar-tab active" onclick="switchTab('all')" id="tab-all">ì „ì²´ (0)</div>
                <div class="sidebar-tab" onclick="switchTab('mine')" id="tab-mine">ë‚´ ìƒë‹´ (0)</div>
                <div class="sidebar-tab" onclick="switchTab('unassigned')" id="tab-unassigned">ë¯¸ë°°ì • (0)</div>
            </div>

            <div id="chatList" class="chat-list-container">
                <!-- ì±„íŒ…ë°© ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </div>
        </div>

        <!-- ë©”ì¸: ì±„íŒ… í™”ë©´ -->
        <div class="main-chat">
            <div id="chatHeader" class="chat-header"
                style="display: none; background: white; color: var(--text-primary); border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="chatroom-avatar" style="width: 32px; height: 32px; font-size: 14px; margin: 0;">U</div>
                    <h3 id="currentUserName">ì‚¬ìš©ì</h3>
                </div>
                <button id="assignBtn" class="assign-btn" style="display: none;" onclick="assignCurrentRoom()">ìƒë‹´
                    ì‹œì‘í•˜ê¸°</button>
            </div>

            <div id="chatPlaceholder" class="chat-placeholder">
                <span style="font-size: 48px;">ğŸ’¬</span>
                <p>ì™¼ìª½ ëª©ë¡ì—ì„œ ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</p>
            </div>

            <div id="chatArea" style="display: none; flex: 1; min-height: 0; flex-direction: column;">
                <div class="messages-container" id="messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="messageInput" class="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                    <button onclick="sendMessage()" class="send-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let currentRoomId = null;
        let currentSubscription = null;
        let readSubscription = null;
        let currentAdminId = null;
        let activeTab = 'all'; // 'all', 'unassigned', or 'mine'

        async function init() {
            try {
                // 1. ë‚´ ì •ë³´ ì¡°íšŒ (ë¡œê·¸ì¸ ì²´í¬)
                const adminRes = await fetch('/api/admins/me');
                if (adminRes.status === 401) {
                    window.location.href = '/index.html';
                    return;
                }
                const adminData = await adminRes.json();
                if (adminData.success) {
                    currentAdminId = adminData.data.id;
                }

                // 2. WebSocket ì—°ê²°
                connectWebSocket();

                // 3. ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
                loadChatRooms();

                // 4. ì „ì²´ íƒ­ ì¹´ìš´íŠ¸ ì´ˆê¸°í™” (ë¹„í™œì„± íƒ­ í¬í•¨)
                updateInitialTabCounts();

            } catch (e) {
                console.error('Init failed', e);
            }
        }

        async function updateInitialTabCounts() {
            try {
                // ë¯¸ë°°ì • ì¹´ìš´íŠ¸
                const resUnassigned = await fetch('/api/admins/chatrooms/unassigned');
                const dataUnassigned = await resUnassigned.json();
                if (dataUnassigned.success) {
                    updateTabCount('unassigned', dataUnassigned.data.chatRooms.length);
                }

                // ë‚´ ìƒë‹´ ì¹´ìš´íŠ¸
                const resMine = await fetch('/api/admins/chatrooms/mine');
                const dataMine = await resMine.json();
                if (dataMine.success) {
                    updateTabCount('mine', dataMine.data.chatRooms.length);
                }

                // ì „ì²´ ì¹´ìš´íŠ¸
                const resAll = await fetch('/api/admins/chatrooms');
                const dataAll = await resAll.json();
                if (dataAll.success) {
                    updateTabCount('all', dataAll.data.chatRooms.length);
                }
            } catch (e) {
                console.error('Failed to update tab counts', e);
            }
        }

        async function switchTab(tab) {
            if (activeTab === tab) return;
            activeTab = tab;

            document.querySelectorAll('.sidebar-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            // íƒ­ ì „í™˜ ì‹œ ì±„íŒ…ë°© ì„ íƒ í•´ì œ (ì‹¬í”Œí•˜ê²Œ)
            currentRoomId = null;
            document.getElementById('chatHeader').style.display = 'none';
            document.getElementById('chatArea').style.display = 'none';
            document.getElementById('chatPlaceholder').style.display = 'flex';
            if (currentSubscription) currentSubscription.unsubscribe();

            loadChatRooms();
        }

        async function loadChatRooms() {
            let endpoint;
            if (activeTab === 'unassigned') endpoint = '/api/admins/chatrooms/unassigned';
            else if (activeTab === 'mine') endpoint = '/api/admins/chatrooms/mine';
            else endpoint = '/api/admins/chatrooms';

            const res = await fetch(endpoint);
            const data = await res.json();

            if (data.success) {
                renderChatList(data.data.chatRooms);
                updateTabCount(activeTab, data.data.chatRooms.length);
            }
        }

        function updateTabCount(tab, count) {
            const el = document.getElementById(`tab-${tab}`);
            let text = '';
            if (tab === 'unassigned') text = 'ë¯¸ë°°ì •';
            else if (tab === 'mine') text = 'ë‚´ ìƒë‹´';
            else text = 'ì „ì²´';

            el.textContent = `${text} (${count})`;
        }

        function renderChatList(rooms) {
            const container = document.getElementById('chatList');
            container.innerHTML = '';

            if (rooms.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding: 20px; color: #888;">ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = `chatroom-item ${currentRoomId === room.id ? 'active' : ''}`;
                div.onclick = () => selectRoom(room.id, room.userEmail, room.assignedAdminEmail);
                div.id = `room-${room.id}`;

                div.innerHTML = `
                    <div class="chatroom-avatar">${room.userEmail[0].toUpperCase()}</div>
                    <div class="chatroom-info">
                        <div class="chatroom-name">${room.userEmail}</div>
                        <div class="chatroom-preview" id="preview-${room.id}">${room.lastMessageContent || 'ëŒ€í™” ì—†ìŒ'}</div>
                    </div>
                    <div class="chatroom-meta">
                        <div class="chatroom-time">${formatTime(room.lastMessageAt)}</div>
                        ${room.unreadCount > 0 ? `<div class="unread-badge" id="badge-${room.id}">${room.unreadCount}</div>` : `<div class="unread-badge hidden" id="badge-${room.id}">0</div>`}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            stompClient.connect({}, () => {
                console.log('Connected');

                // ì±„íŒ…ë°© ëª©ë¡ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ êµ¬ë… (Admin ì „ìš© ì±„ë„ - ê¸°ì¡´)
                stompClient.subscribe('/topic/admin/chatrooms', (message) => {
                    const noti = JSON.parse(message.body);
                    // ë¯¸ë°°ì • íƒ­ì´ê±°ë‚˜, ë‚´ ë‹´ë‹¹ ì±„íŒ…ë°©ì´ë©´ ì—…ë°ì´íŠ¸
                    // (ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ í˜„ì¬ íƒ­ ìƒˆë¡œê³ ì¹¨ í˜¹ì€ ë¡œì§ ìˆ˜í–‰)
                    // ì—¬ê¸°ì„œëŠ” ë§Œì•½ ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ë°©ì´ë©´ ì—…ë°ì´íŠ¸, ì•„ë‹ˆë©´ (ìƒˆ ë©”ì‹œì§€ë©´) ë¡œë“œ
                    updateChatRoomPreview(noti);
                });

                // ë°°ì • ì•Œë¦¼ êµ¬ë…
                stompClient.subscribe('/topic/admin/assignments', (message) => {
                    const noti = JSON.parse(message.body);
                    handleAssignmentNotification(noti);
                });

                // ì½ìŒ ì•Œë¦¼(ëª©ë¡ ê°±ì‹ ìš©) êµ¬ë…
                stompClient.subscribe('/topic/admin/reads', (message) => {
                    const noti = JSON.parse(message.body);
                    handleReadNotificationForList(noti);
                });

            });
        }

        function handleReadNotificationForList(noti) {
            // noti.readByType == 'ADMIN' ì´ë©´, Adminì´ ì½ì—ˆìœ¼ë¯€ë¡œ ë±ƒì§€ë¥¼ 0ìœ¼ë¡œ ë§Œë“¦
            if (noti.readByType === 'ADMIN') {
                const badge = document.getElementById(`badge-${noti.chatRoomId}`);
                if (badge) {
                    badge.textContent = '0';
                    badge.classList.add('hidden');
                }
            }
        }

        function handleAssignmentNotification(noti) {
            // ë‚´ê°€ ë°°ì •ë°›ì€ ê²½ìš°
            if (noti.assignedAdminId === currentAdminId) {
                if (activeTab === 'mine') {
                    loadChatRooms(); // ëª©ë¡ ë¦¬ë¡œë“œ
                } else {
                    // ë¯¸ë°°ì • íƒ­ì— ìˆì—ˆë‹¤ë©´ í•´ë‹¹ ë°© ì œê±°
                    const el = document.getElementById(`room-${noti.chatRoomId}`);
                    if (el) {
                        el.remove();
                        updateTabCount(activeTab, document.querySelectorAll('.chatroom-item').length);
                    }
                }
            } else {
                // ë‹¤ë¥¸ ì‚¬ëŒì´ ë°°ì •ë°›ì€ ê²½ìš° -> ë¯¸ë°°ì • íƒ­ì—ì„œ ì œê±°
                if (activeTab === 'unassigned') {
                    const el = document.getElementById(`room-${noti.chatRoomId}`);
                    if (el) {
                        el.remove();
                        updateTabCount(activeTab, document.querySelectorAll('.chatroom-item').length);
                    } else {
                        // í˜¹ì‹œ ë°ì´í„° ë¶ˆì¼ì¹˜ ë“±ìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ì— ì—†ì§€ë§Œ ì¹´ìš´íŠ¸ ê°±ì‹  í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜,
                        // ì—¬ê¸°ì„œëŠ” ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ì¹´ìš´íŠ¸ í•˜ë¯€ë¡œ íŒ¨ìŠ¤
                        loadChatRooms(); // ì•ˆì „í•˜ê²Œ ë¦¬ë¡œë“œ
                    }
                }
            }

            // ì „ì²´ íƒ­ì¸ ê²½ìš° -> ë¦¬ë¡œë“œ (ë‹´ë‹¹ì ì •ë³´ ê°±ì‹  ë“±)
            if (activeTab === 'all') {
                loadChatRooms();
            }
        }

        function updateChatRoomPreview(noti) {
            // í˜„ì¬ ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ë°©ì¸ì§€ í™•ì¸
            const roomEl = document.getElementById(`room-${noti.chatRoomId}`);

            // íƒ­ì— ë”°ë¼ ì²˜ë¦¬ ë¡œì§ ë¶„ê¸°
            const belongsToUnassigned = !noti.assignedAdminId;
            const belongsToMe = noti.assignedAdminId === currentAdminId;

            let tabToUpdate = null;
            if (activeTab === 'unassigned') {
                if (belongsToUnassigned) {
                    if (!roomEl) {
                        loadChatRooms(); // ë¦¬ë¡œë“œ ì‹œ ì¹´ìš´íŠ¸ë„ ê°±ì‹ ë¨
                        return;
                    }
                } else {
                    if (roomEl) {
                        roomEl.remove();
                        // í˜„ì¬ íƒ­ ì¹´ìš´íŠ¸ ê°ì†Œ
                        updateTabCount(activeTab, document.querySelectorAll('.chatroom-item').length);
                    }
                    return;
                }
            } else if (activeTab === 'mine') {
                if (belongsToMe) {
                    if (!roomEl) {
                        loadChatRooms();
                        return;
                    }
                } else {
                    if (roomEl) {
                        roomEl.remove();
                        updateTabCount(activeTab, document.querySelectorAll('.chatroom-item').length);
                    }
                    return;
                }
            } else if (activeTab === 'all') {
                // ì „ì²´ íƒ­ì€ ëª¨ë“  ë°©ì„ ë³´ì—¬ì£¼ë¯€ë¡œ í•­ìƒ ì—…ë°ì´íŠ¸/ì¶”ê°€
                if (!roomEl) {
                    loadChatRooms();
                    return;
                }
            }

            // ì—¬ê¸°ì„œë¶€í„°ëŠ” ë¦¬ìŠ¤íŠ¸ì— ì—˜ë¦¬ë¨¼íŠ¸ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°
            if (!roomEl) return;

            // í”„ë¦¬ë·° ì—…ë°ì´íŠ¸
            document.getElementById(`preview-${noti.chatRoomId}`).textContent = noti.lastMessageContent;

            // í˜„ì¬ ë³´ê³ ìˆëŠ” ë°©ì´ ì•„ë‹ˆë©´ ë±ƒì§€ ì—…ë°ì´íŠ¸
            if (currentRoomId !== noti.chatRoomId) {
                const badge = document.getElementById(`badge-${noti.chatRoomId}`);
                if (badge) {
                    badge.textContent = noti.unreadCount;
                    badge.classList.remove('hidden');
                }

                // ëª©ë¡ ë§¨ ìœ„ë¡œ ì˜¬ë¦¬ê¸°
                const container = document.getElementById('chatList');
                if (container.firstChild !== roomEl) {
                    container.insertBefore(roomEl, container.firstChild);
                }
            }
        }

        async function selectRoom(roomId, userEmail, assignedAdminEmail) {
            currentRoomId = roomId;
            document.getElementById('currentUserName').textContent = userEmail;

            // UI ì „í™˜
            document.getElementById('chatPlaceholder').style.display = 'none';
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('chatArea').style.display = 'flex';

            // ë°°ì • ë²„íŠ¼ ì²˜ë¦¬
            const assignBtn = document.getElementById('assignBtn');
            if (activeTab === 'unassigned' && !assignedAdminEmail) {
                assignBtn.style.display = 'block';
                // ì…ë ¥ì°½ ë¹„í™œì„±í™”?
                document.getElementById('messageInput').disabled = true;
                document.getElementById('messageInput').placeholder = "ìƒë‹´ ì‹œì‘í•˜ê¸°ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”";
            } else {
                assignBtn.style.display = 'none';
                document.getElementById('messageInput').disabled = false;
                document.getElementById('messageInput').placeholder = "ë©”ì‹œì§€ ì…ë ¥...";
            }

            // ë±ƒì§€ ì œê±°
            const badge = document.getElementById(`badge-${roomId}`);
            if (badge) badge.classList.add('hidden');

            // ì´ì „ êµ¬ë… í•´ì œ
            if (currentSubscription) currentSubscription.unsubscribe();
            if (readSubscription) readSubscription.unsubscribe();

            // APIë¡œ ë©”ì‹œì§€ ë¡œë“œ (ì…ì¥ ì²˜ë¦¬ -> ì½ìŒ ì²˜ë¦¬ ë¨)
            const res = await fetch(`/api/chatrooms/${roomId}?isAdmin=true`); // isAdmin íŒŒë¼ë¯¸í„° í•„ìš”í• ìˆ˜ë„? enterChatRoom controller í™•ì¸ í•„ìš”. 
            // í˜„ì¬ enterChatRoomì€ /api/chatrooms/{id} ë¡œ ë§¤í•‘ë˜ì–´ìˆê³ , ì„¸ì…˜ì—ì„œ userType ì²´í¬í•¨.
            // param í•„ìš” ì—†ìŒ.

            const dataRes = await fetch(`/api/chatrooms/${roomId}`);
            const data = await dataRes.json();

            if (data.success) {
                renderMessages(data.data.messages);
                scrollToBottom();

                // ìƒˆ ë°© êµ¬ë…
                currentSubscription = stompClient.subscribe(`/topic/chat/${roomId}`, (message) => {
                    const msg = JSON.parse(message.body);
                    displayMessage(msg);
                    scrollToBottom();

                    // ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì½ìŒ ì²˜ë¦¬ (ë‚´ê°€ ë³´ëŠ” ë°©ì— ìƒˆ ë©”ì‹œì§€ê°€ ì™”ìœ¼ë¯€ë¡œ)
                    // ë‹¨, ë‚´ ë©”ì‹œì§€ëŠ” ì œì™¸í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì„œë²„ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ê·¸ëƒ¥ ë³´ëƒ„
                    stompClient.send(`/app/chat/${roomId}/read`, {}, {});
                });

                // ì…ì¥ ì‹œ ì½ìŒ ì²˜ë¦¬ ì „ì†¡
                stompClient.send(`/app/chat/${roomId}/read`, {}, {});

                // ì½ìŒ ì•Œë¦¼ êµ¬ë…
                readSubscription = stompClient.subscribe(`/topic/chat/${roomId}/read`, (message) => {
                    markAllAsRead();
                });
            }
        }

        async function assignCurrentRoom() {
            if (!currentRoomId) return;
            if (!confirm("ì´ ìƒë‹´ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const res = await fetch(`/api/admins/chatrooms/${currentRoomId}/assign`, { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                alert("ìƒë‹´ì´ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                // ë‚´ ìƒë‹´ íƒ­ìœ¼ë¡œ ì´ë™
                switchTab('mine');
                // ë°©ê¸ˆ ê·¸ ë°© ì„ íƒ (ì•½ê°„ ë³µì¡í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì¼ë‹¨ íƒ­ ì´ë™ë§Œ)
            } else {
                alert("ë°°ì • ì‹¤íŒ¨: " + (data.error?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            messages.forEach(displayMessage);
        }

        function displayMessage(msg) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');

            // ADMINì´ ë³´ë‚¸ ë©”ì‹œì§€ = ë‚˜(Admin)ì—ê²ŒëŠ” 'user' í´ë˜ìŠ¤ (ì˜¤ë¥¸ìª½ - ìƒ‰ìƒì€ CSSë¡œ ì¡°ì •)
            // USERê°€ ë³´ë‚¸ ë©”ì‹œì§€ = ë‚˜(Admin)ì—ê²ŒëŠ” 'admin' í´ë˜ìŠ¤ (ì™¼ìª½)
            // ì£¼ì˜: style.cssì—ì„œ .message.userë¥¼ ì˜¤ë¥¸ìª½(ë‚´êº¼), .message.adminì„ ì™¼ìª½(ìƒëŒ€)ìœ¼ë¡œ ì •ì˜í–ˆìŒ.
            // ì—¬ê¸°ì„œëŠ” `isMe`ê°€ ì°¸ì´ë©´ `.message.user` í´ë˜ìŠ¤ë¥¼ ì¤˜ì„œ ì˜¤ë¥¸ìª½ì— ë°°ì¹˜í•´ì•¼ í•¨.

            const isMe = msg.senderType === 'ADMIN';

            div.className = `message ${isMe ? 'user' : 'admin'}`;

            div.innerHTML = `
                <div class="message-bubble">
                    ${msg.content}
                </div>
                <div class="message-meta">
                    ${isMe ? `<span class="read-indicator ${msg.isRead ? 'read' : ''}" data-msg-id="${msg.id}">${msg.isRead ? 'ì½ìŒ' : 'ì•ˆì½ìŒ'}</span>` : ''}
                    <span>${formatTime(msg.createdAt)}</span>
                </div>
            `;

            container.appendChild(div);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (input.disabled) {
                alert("ë¨¼ì € ìƒë‹´ì„ ì‹œì‘(ë°°ì •)í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (content && stompClient && currentRoomId) {
                stompClient.send(`/app/chat/${currentRoomId}/send`, {}, JSON.stringify({
                    content: content
                }));
                input.value = '';
                input.focus();
            }
        }

        function markAllAsRead() {
            document.querySelectorAll('.read-indicator').forEach(el => {
                el.textContent = 'ì½ìŒ';
                el.classList.add('read');
            });
        }

        function scrollToBottom() {
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr.replace(' ', 'T'));
            return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        function logout() {
            fetch('/api/admins/logout', { method: 'POST' })
                .then(() => window.location.href = '/index.html');
        }

        // Enter í‚¤
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        init();
    </script>
</body>

</html>